# Windows 应用程序证书签名指南

## 问题说明

Windows 10/11 要求所有 MSIX 应用包必须使用受信任的证书进行签名，否则用户无法安装。错误信息：
```
你需要为此应用包安装新证书，或者使用带受信任证书的新应用包。
已处理证书链，但处理过程因根证书不受信任而终止 (0x800B0109)
```

## 解决方案

### 方案1：自签名证书（开发/测试环境）

适用于内部测试、开发环境。用户需要手动安装证书到"受信任的根证书颁发机构"。

#### 步骤1：创建自签名证书

在 Windows PowerShell（管理员权限）中运行：

```powershell
# 进入项目目录
cd /path/to/student_exam

# 运行证书创建脚本
powershell -ExecutionPolicy Bypass -File scripts/create_test_certificate.ps1
```

这将生成两个文件：
- `hongshi_test_cert.pfx` - 用于签名应用（密码：hongshi2024）
- `hongshi_test_cert.cer` - 用于安装到用户电脑

#### 步骤2：构建并签名应用

```bash
# 确保证书文件在项目根目录
# 运行构建脚本
bash scripts/build_win.sh
```

#### 步骤3：在目标电脑上安装证书

**每台需要安装应用的电脑都需要执行此步骤：**

1. 双击 `hongshi_test_cert.cer` 文件
2. 点击"安装证书"
3. 选择"本地计算机"（需要管理员权限）
4. 点击"下一步"
5. 选择"将所有证书放入下列存储"
6. 点击"浏览"，选择"受信任的根证书颁发机构"
7. 点击"确定"，然后"下一步"
8. 点击"完成"
9. 在安全警告中点击"是"

完成后即可安装应用。

---

### 方案2：购买商业代码签名证书（生产环境）

适用于正式发布、公开分发。用户无需手动安装证书。

#### 推荐的证书颁发机构

1. **DigiCert**（最推荐）
   - 网址：https://www.digicert.com
   - 价格：约 $474/年
   - 优点：业界标准，Windows完全信任

2. **Sectigo (原 Comodo)**
   - 网址：https://sectigo.com
   - 价格：约 $200-300/年
   - 优点：性价比高

3. **GlobalSign**
   - 网址：https://www.globalsign.com
   - 价格：约 $300-400/年

#### 购买流程

1. 选择"代码签名证书"（Code Signing Certificate）
2. 提供公司信息和验证材料：
   - 营业执照
   - 组织机构代码证
   - 法人身份证
   - 公司电话验证
3. 等待审核（通常3-7个工作日）
4. 下载证书（.pfx 或 .p12 格式）

#### 使用商业证书签名

1. 将证书文件重命名为 `hongshi_prod_cert.pfx`
2. 修改 `build_win.sh` 中的证书路径和密码：

```bash
CERT_FILE="hongshi_prod_cert.pfx"
CERT_PASSWORD="你的证书密码"
```

3. 运行构建脚本：

```bash
bash scripts/build_win.sh
```

---

### 方案3：使用 Inno Setup 安装程序（无需证书）

如果不想处理证书问题，可以使用传统的 `.exe` 安装程序。

#### 优点
- 无需证书
- 用户熟悉的安装方式
- 可以自定义安装过程

#### 缺点
- 不是 Windows Store 格式
- Windows Defender 可能会警告（但可以继续安装）

#### 使用方法

构建脚本已包含 Inno Setup 支持，会自动生成：
- `build/红师教育学生端_setup.exe`

用户运行此文件即可安装，无需证书。

---

## 推荐方案

### 开发/内部测试
使用**方案1**（自签名证书），成本为零，适合内部使用。

### 正式发布
- **小规模分发**：使用**方案3**（Inno Setup），简单快捷
- **大规模分发/企业客户**：使用**方案2**（商业证书），更专业可信

---

## 常见问题

### Q1: 自签名证书安全吗？
A: 自签名证书本身是安全的，但Windows无法验证发布者身份。适合内部使用，不适合公开分发。

### Q2: 商业证书一定要买吗？
A: 不一定。如果只是内部使用或小范围分发，可以使用自签名证书或Inno Setup安装程序。

### Q3: 证书过期了怎么办？
A: 
- 自签名证书：重新生成并分发新证书
- 商业证书：续费并重新签名应用

### Q4: 能否使用免费的证书？
A: Windows代码签名证书没有免费选项，必须购买。但可以使用自签名证书作为替代。

### Q5: 已签名的应用还会被Windows Defender拦截吗？
A: 
- 商业证书：通常不会，除非应用被标记为恶意软件
- 自签名证书：可能会有警告，但用户可以选择继续安装

---

## 技术支持

如有问题，请联系开发团队。
